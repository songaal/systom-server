<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="card">

    <select id="getCardCount" resultType="Integer" parameterType="String">
        SELECT COUNT(*)
          FROM card
         WHERE user_id = #{param1}
    </select>

    <insert id="registerCard" parameterType="Card" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO card (user_id, card_no, owner, month, year, birth_date, name, address, phone, is_default, type)
         VALUE (#{userId},
                aes_encrypt(#{cardNo}, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{userId})),
                aes_encrypt(#{owner}, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{userId})),
                #{month},
                #{year},
                aes_encrypt(#{birthDate}, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{userId})),
                #{name},
                aes_encrypt(#{address}, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{userId})),
                aes_encrypt(#{phone}, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{userId})),
                #{isDefault},
                #{type}
        )
    </insert>

    <select id="retrieveCardList" resultType="Card" parameterType="String">
        SELECT id
             , user_id
             , right(aes_decrypt(card_no, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as card_no
             , right(aes_decrypt(owner, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as owner
             , month
             , year
             , right(aes_decrypt(birth_date, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as birth_date
             , name
             , right(aes_decrypt(address, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as address
             , right(aes_decrypt(phone, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as phone
             , is_default
             , type
          FROM card
         WHERE user_id = #{param1}
    </select>

    <select id="getCard" resultType="Card" parameterType="HashMap">
        SELECT id
             , user_id
             , right(aes_decrypt(card_no, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as card_no
             , right(aes_decrypt(owner, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as owner
             , month
             , year
             , right(aes_decrypt(birth_date, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as birth_date
             , name
             , right(aes_decrypt(address, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as address
             , right(aes_decrypt(phone, concat('ytCvvWEKB3DsHmeg7Almr26MWeoyCjLkfd', #{param1})), 4) as phone
             , is_default
             , type
          FROM card
         WHERE id = #{id}
    </select>

    <update id="updateDefaultReset" parameterType="Card">
        UPDATE card
           SET is_default = false
         WHERE user_id = #{userId}
    </update>

    <update id="updateDefault" parameterType="Card">
        UPDATE card
           SET is_default = true
         WHERE user_id = #{userId}
           AND id = #{id}
    </update>

    <delete id="deleteCard" parameterType="Integer">
        DELETE card
         WHERE id = #{param1}
    </delete>
</mapper>
