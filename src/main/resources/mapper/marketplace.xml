<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="marketplace">

    <select id="retrieveStrategyMarketList" resultType="StrategyDeploy" parameterType="String">
        SELECT
            a.id,
            d.version,
            a.is_sell,
            a.create_time,
            a.price,
            a.backtest,
            a.options,
            a.description,
            b.name,
            b.user_id,
            IFNULL(c.sell_count, 0) AS sell_count,
            IFNULL((SELECT 'purchase'
                      FROM strategy_sell_history ee
                     WHERE ee.user_id = #{param1}
                       AND ee.strategy_id= a.id
                     GROUP BY ee.strategy_id), 'Unpurchase') as is_purchase,
            IF(#{param1} = a.user_id, false, true) as is_buyer
        FROM strategy_deploy a
        INNER JOIN strategy b ON a.id = b.id
        LEFT JOIN (SELECT aa.strategy_id, COUNT(aa.user_id) AS sell_count
                     FROM strategy_sell_history aa
                    GROUP BY aa.id) c ON a.id = c.strategy_id
        INNER JOIN (SELECT bb.id,
                           MAX(bb.version) AS version
                      FROM strategy_deploy bb
                     WHERE bb.is_sell = 'selling'
                     GROUP BY bb.id) d ON d.id = a.id AND a.version = d.version
    </select>

    <update id="registerStrategyMarket" parameterType="StrategyDeploy">
        UPDATE strategy_deploy
           SET is_sell = 'selling'
             , price = ${price}
             , description = #{description}
             , market_create_time = now()
         WHERE id = ${id}
           AND version = ${version}
    </update>

    <update id="stopSellingStrategyMarket" parameterType="StrategyDeploy">
        UPDATE strategy_deploy
           SET is_sell = 'stop'
         WHERE id = ${id}
           AND user_id = #{userId}
           AND version = ${version}
    </update>

</mapper>
