<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="userMonthlyInvest">

    <!--SELECT SUBSTRING_INDEX(-->
    <!--SUBSTRING_INDEX(-->
    <!--SUBSTRING_INDEX('{"KRW":0.7768829,"USDT":0.98141235}', '"USDT":' , -1)-->
    <!--, ',' ,1)-->
    <!--, '}', 1)-->


    <select id="retrieveUserMonthInvestList" resultType="UserMonthlyInvest">
        SELECT a.user_id
             , a.date
             , a.init_cash
             , a.monthly_return
             , a.monthly_return_pct
             , a.update_time
             , b.sum_cash
          FROM user_monthly_invest a
          JOIN (SELECT aa.user_id
                     , SUM(aa.init_cash) as sum_cash
                  FROM user_monthly_invest aa
                 WHERE aa.user_id = #{param1}
                 GROUP BY aa.user_id
             ) b on a.user_id = b.user_id
         WHERE a.user_id = #{param1}
         ORDER BY a.date asc
         LIMIT 6
    </select>

    <select id="getDailyInvest" parameterType="String" resultType="HashMap">
        <![CDATA[
        SELECT SUM(aa.init_cash) as cash
             , SUM(aa.equity) as equity
             , date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as date
          FROM performance_summary aa
         WHERE aa.invest_id in ( SELECT bbb.id
                                   FROM goods aaa
                                   JOIN invest_goods bbb on aaa.id = bbb.goods_id
                                  WHERE bbb.user_id = #{param1}
                                    AND (cast(aaa.invest_start as decimal) <= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m%d') as decimal)
                                    AND cast(aaa.invest_end as decimal) >= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m%d') as decimal)) )
        ]]>
    </select>

    <select id="retrieveUpdateTargetUserList" resultType="String">
        <![CDATA[
        SELECT bb.user_id
          FROM goods aa
          JOIN invest_goods bb on aa.id = bb.goods_id
         WHERE (cast(substring(aa.collect_start, 1, 6) as decimal) <= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as decimal)
           AND cast(substring(aa.invest_end, 1, 6) as decimal) >= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as decimal) )
         GROUP BY bb.user_id
        ]]>
    </select>

    <select id="getUserMonthlyInvest" parameterType="String" resultType="UserMonthlyInvest">
        <![CDATA[
        SELECT aa.init_cash
             , aa.equity
             , cc.cash_unit
             , date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as date
          FROM performance_summary aa
          JOIN invest_goods bb on aa.invest_id = bb.id
          JOIN goods cc on bb.goods_id = cc.id
         WHERE aa.invest_id in ( SELECT bbb.id
                                   FROM goods aaa
                                   JOIN invest_goods bbb on aaa.id = bbb.goods_id
                                  WHERE bbb.user_id = #{param1}
                                    AND (cast(substring(aaa.invest_start, 1, 6) as decimal) <= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as decimal)
                                    AND cast(substring(aaa.invest_end, 1, 6) as decimal) >= cast(date_format(convert_tz(now(), @@session.time_zone, '${standardOffset}'), '%Y%m') as decimal)) )
        ]]>
    </select>

    <update id="updateMonthlyInvest" parameterType="UserMonthlyInvest">
        INSERT INTO user_monthly_invest (user_id, date, init_cash, monthly_return, monthly_return_pct)
        VALUES ( #{userId}
               , #{date}
               , ${initCash}
               , ${monthlyReturn}
               , ${monthlyReturnPct}
        )
        ON DUPLICATE KEY
        UPDATE init_cash = ${initCash}
             , monthly_return = ${monthlyReturn}
             , monthly_return_pct = ${monthlyReturnPct}
             , update_time = convert_tz(now(), @@session.time_zone, '${standardOffset}')
    </update>
</mapper>
