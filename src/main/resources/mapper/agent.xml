<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="agent">

    <insert id="insertAgent" parameterType="Agent" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO agent
        (id,strategy_id,strategy_version,name,exchange_key_id,capital_base,base_currency,create_time,options,state,user_id)
        VALUES
        (
            #{id}
            ,#{strategyId}
            ,#{strategyVersion}
            ,#{name}
            ,#{exchangeKeyId,jdbcType=INTEGER}
            ,#{capitalBase}
            ,#{baseCurrency}
            ,now()
            ,#{options}
            ,#{state}
            ,#{userId}
        )
    </insert>

    <update id="updateAgent" parameterType="Agent">
        update agent
         set id = #{id}
        <if test="name != null and name != ''">
            , name = #{name}
        </if>
        <if test="strategyId != null and strategyId != ''">
            , strategy_id = #{strategyId}
        </if>
        <if test="exchangeKeyId != null and exchangeKeyId != ''">
            , exchange_key_id = #{exchangeKeyId}
        </if>
        <if test="strategyVersion != null and strategyVersion != ''">
            , strategy_version = #{strategyVersion}
        </if>
        <if test="capitalBase != null and capitalBase != ''">
            , capital_base = #{capitalBase}
        </if>
        <if test="baseCurrency != null and baseCurrency != ''">
            , base_currency = #{baseCurrency}
        </if>
        <if test="options != null and options != ''">
            , options = #{options}
        </if>
        <if test="state != null and state != ''">
            , state = #{state}
        </if>
        <if test="ecsTaskId != null and ecsTaskId != ''">
            , ecs_task_id = #{ecsTaskId}
        </if>
        where id = #{id}
    </update>

    <select id="selectAgent" parameterType="Agent" resultType="Agent">
        SELECT  a.id,
        a.strategy_id,
        a.strategy_version,
        a.name,
        a.revenue,
        a.exchange_key_id,
        a.capital_base,
        a.base_currency,
        a.coin,
        a.create_time,
        a.options,
        a.state,
        a.user_id,
        a.ecs_task_id,
        b.name as strategy_name,
        c.exchange_name,
        c.name as exchange_key_name
        FROM agent a
        join strategy b on a.strategy_id = b.id and a.strategy_version = b.version
        join exchange_key c on a.exchange_key_id = c.id
        where 1=1
        <choose>
            <when test="id != null and id != ''">and a.id = #{id}</when>
            <when test="userId != null and userId != ''">and a.user_id = #{userId}</when>
            <otherwise>and 1=2</otherwise>
        </choose>
        order by create_time desc
    </select>

    <delete id="deleteAgent" parameterType="Agent">
        delete from agent
         where id = #{id}
    </delete>

</mapper>
